# ===================================================
# SCRIPT DE DEPLOY AUTOM√ÅTICO - HELMER ACADEMY
# PowerShell para automa√ß√£o de deploy
# ===================================================

param(
    [string]$Environment = "production",
    [string]$Target = "hostinger"
)

# Configura√ß√µes
$ProjectName = "helmer-academy"
$DeployDir = "deploy"
$BackupDir = "backups"
$Timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$StartTime = Get-Date

# Cores para output
$Red = "Red"
$Green = "Green"
$Yellow = "Yellow"
$Blue = "Blue"
$White = "White"
$Cyan = "Cyan"

# Log de deploy
$LogFile = "deploy-log-$Timestamp.txt"
$LogContent = @()

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $LogEntry = "[$(Get-Date -Format 'HH:mm:ss')] [$Level] $Message"
    $LogContent += $LogEntry
    Write-Host $LogEntry -ForegroundColor $(if($Level -eq "ERROR") { $Red } elseif($Level -eq "SUCCESS") { $Green } elseif($Level -eq "WARNING") { $Yellow } else { $White })
}

function Save-Log {
    $LogContent | Out-File -FilePath $LogFile -Encoding UTF8
    Write-Log "Log salvo em: $LogFile" "INFO"
}

Write-Host "===================================================" -ForegroundColor $Blue
Write-Host "üöÄ DEPLOY AUTOM√ÅTICO - HELMER ACADEMY" -ForegroundColor $Blue
Write-Host "===================================================" -ForegroundColor $Blue
Write-Log "Iniciando deploy autom√°tico" "INFO"
Write-Log "Ambiente: $Environment" "INFO"
Write-Log "Target: $Target" "INFO"
Write-Log "Timestamp: $Timestamp" "INFO"
Write-Log "Hora de in√≠cio: $($StartTime.ToString('dd/MM/yyyy HH:mm:ss'))" "INFO"

try {
    # 1. Verificar se estamos no diret√≥rio correto
    Write-Log "Verificando diret√≥rio do projeto" "INFO"
    if (-not (Test-Path "index.php")) {
        Write-Log "ERRO: Execute este script no diret√≥rio raiz do projeto" "ERROR"
        throw "Execute este script no diret√≥rio raiz do projeto"
    }
    Write-Log "Diret√≥rio do projeto verificado com sucesso" "SUCCESS"

    # 2. Criar backup
    $BackupStartTime = Get-Date
    Write-Log "Iniciando processo de backup" "INFO"
    if (Test-Path $BackupDir) {
        Remove-Item $BackupDir -Recurse -Force
        Write-Log "Diret√≥rio de backup anterior removido" "INFO"
    }
    New-Item -ItemType Directory -Path $BackupDir -Force | Out-Null
    Write-Log "Diret√≥rio de backup criado" "SUCCESS"
    
    # Backup de arquivos importantes
    $BackupFiles = 0
    if (Test-Path "uploads") {
        Copy-Item "uploads" "$BackupDir\uploads" -Recurse -Force
        $BackupFiles++
        Write-Log "Pasta uploads copiada para backup" "SUCCESS"
    }
    if (Test-Path "cache") {
        Copy-Item "cache" "$BackupDir\cache" -Recurse -Force
        $BackupFiles++
        Write-Log "Pasta cache copiada para backup" "SUCCESS"
    }
    if (Test-Path "config.php") {
        Copy-Item "config.php" "$BackupDir\config.php" -Force
        $BackupFiles++
        Write-Log "Arquivo config.php copiado para backup" "SUCCESS"
    }
    
    $BackupTime = (Get-Date) - $BackupStartTime
    Write-Log "Backup conclu√≠do em $($BackupTime.TotalSeconds.ToString('F2')) segundos - $BackupFiles arquivos" "SUCCESS"

    # 3. Preparar diret√≥rio de deploy
    Write-Host "üîß Preparando deploy..." -ForegroundColor $Green
    if (Test-Path $DeployDir) {
        Remove-Item $DeployDir -Recurse -Force
    }
    New-Item -ItemType Directory -Path $DeployDir -Force | Out-Null

    # 4. Copiar arquivos PHP
    Write-Host "üìã Copiando arquivos PHP..." -ForegroundColor $Green
    Get-ChildItem -Path "*.php" | Copy-Item -Destination $DeployDir -Force

    # 5. Copiar diret√≥rios necess√°rios
    $Directories = @("css", "js", "pages", "fotos")
    foreach ($dir in $Directories) {
        if (Test-Path $dir) {
            Copy-Item $dir "$DeployDir\$dir" -Recurse -Force
            Write-Host "‚úÖ Copiado: $dir" -ForegroundColor $Green
        }
    }

    # 6. Copiar arquivos de configura√ß√£o
    $ConfigFiles = @("manifest.json", "sw.js", ".htaccess")
    foreach ($file in $ConfigFiles) {
        if (Test-Path $file) {
            Copy-Item $file "$DeployDir\$file" -Force
            Write-Host "‚úÖ Copiado: $file" -ForegroundColor $Green
        }
    }

    # 7. Criar diret√≥rios necess√°rios
    Write-Host "üìÅ Criando diret√≥rios..." -ForegroundColor $Green
    $RequiredDirs = @(
        "$DeployDir\uploads\banners",
        "$DeployDir\uploads\categorias", 
        "$DeployDir\uploads\cursos",
        "$DeployDir\uploads\produtos",
        "$DeployDir\cache",
        "$DeployDir\logs",
        "$DeployDir\icons"
    )
    
    foreach ($dir in $RequiredDirs) {
        New-Item -ItemType Directory -Path $dir -Force | Out-Null
    }

    # 8. Configurar para produ√ß√£o
    if (Test-Path "config_production.php") {
        Copy-Item "config_production.php" "$DeployDir\config.php" -Force
        Write-Host "‚úÖ Configura√ß√£o de produ√ß√£o aplicada" -ForegroundColor $Green
    }

    # 9. Criar arquivo de vers√£o
    $VersionContent = @"
Helmer Academy - Deploy Autom√°tico
Vers√£o: 1.0.0
Data: $(Get-Date -Format 'dd/MM/yyyy HH:mm:ss')
Build: $Timestamp
Ambiente: $Environment
Target: $Target
"@
    $VersionContent | Out-File -FilePath "$DeployDir\version.txt" -Encoding UTF8

    # 10. Criar .htaccess otimizado
    $HtaccessContent = @"
# Helmer Academy - Configura√ß√µes Apache
RewriteEngine On

# Seguran√ßa
<Files ".env">
    Order allow,deny
    Deny from all
</Files>

<Files "*.log">
    Order allow,deny
    Deny from all
</Files>

# Cache
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
</IfModule>

# Compress√£o
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/css application/javascript
</IfModule>
"@
    $HtaccessContent | Out-File -FilePath "$DeployDir\.htaccess" -Encoding UTF8

    # 11. Criar script de instala√ß√£o
    $InstallContent = @"
<?php
/**
 * Script de Instala√ß√£o - Helmer Academy
 * Deploy Autom√°tico - $Timestamp
 */
echo "<h1>üöÄ Helmer Academy - Instala√ß√£o Autom√°tica</h1>";
echo "<p>Verificando configura√ß√µes...</p>";

// Verificar permiss√µes
$dirs = ['uploads', 'cache', 'logs'];
foreach ($dirs as $dir) {
    if (!is_writable($dir)) {
        echo "<p style='color: red;'>‚ùå Diret√≥rio $dir n√£o tem permiss√£o de escrita</p>";
    } else {
        echo "<p style='color: green;'>‚úÖ Diret√≥rio $dir OK</p>";
    }
}

// Verificar extens√µes PHP
$required_extensions = ['pdo', 'pdo_mysql', 'gd', 'json'];
foreach ($required_extensions as $ext) {
    if (extension_loaded($ext)) {
        echo "<p style='color: green;'>‚úÖ Extens√£o $ext OK</p>";
    } else {
        echo "<p style='color: red;'>‚ùå Extens√£o $ext n√£o encontrada</p>";
    }
}

echo "<p><strong>Deploy autom√°tico conclu√≠do!</strong></p>";
echo "<p><a href='index.php'>Acessar aplica√ß√£o</a></p>";
?>
"@
    $InstallContent | Out-File -FilePath "$DeployDir\install.php" -Encoding UTF8

    # 12. Criar health check
    $HealthContent = @"
<?php
header('Content-Type: application/json');

$health = [
    'status' => 'ok',
    'timestamp' => date('Y-m-d H:i:s'),
    'version' => '1.0.0',
    'build' => '$Timestamp',
    'environment' => '$Environment',
    'checks' => []
];

// Verificar banco de dados
try {
    require_once 'config.php';
    $health['checks']['database'] = 'ok';
} catch (Exception $e) {
    $health['status'] = 'error';
    $health['checks']['database'] = 'error: ' . $e->getMessage();
}

// Verificar diret√≥rios
$dirs = ['uploads', 'cache', 'logs'];
foreach ($dirs as $dir) {
    if (is_writable($dir)) {
        $health['checks']["dir_$dir"] = 'ok';
    } else {
        $health['status'] = 'error';
        $health['checks']["dir_$dir"] = 'error: not writable';
    }
}

echo json_encode($health, JSON_PRETTY_PRINT);
?>
"@
    $HealthContent | Out-File -FilePath "$DeployDir\health_check.php" -Encoding UTF8

    # 13. Criar ZIP para upload
    Write-Host "üì¶ Criando arquivo ZIP..." -ForegroundColor $Green
    $ZipPath = "helmer-academy-deploy-$Timestamp.zip"
    Compress-Archive -Path "$DeployDir\*" -DestinationPath $ZipPath -Force

    # 14. Estat√≠sticas finais
    $EndTime = Get-Date
    $TotalTime = $EndTime - $StartTime
    $FileCount = (Get-ChildItem $DeployDir -Recurse -File).Count
    $ZipSize = [math]::Round((Get-Item $ZipPath).Length / 1MB, 2)

    Write-Host "===================================================" -ForegroundColor $Blue
    Write-Host "‚úÖ DEPLOY AUTOM√ÅTICO CONCLU√çDO COM SUCESSO!" -ForegroundColor $Green
    Write-Host "===================================================" -ForegroundColor $Blue
    
    # Log de estat√≠sticas
    Write-Log "DEPLOY FINALIZADO COM SUCESSO" "SUCCESS"
    Write-Log "Tempo total de execu√ß√£o: $($TotalTime.TotalSeconds.ToString('F2')) segundos" "SUCCESS"
    Write-Log "Arquivos processados: $FileCount" "SUCCESS"
    Write-Log "Tamanho do ZIP: $ZipSize MB" "SUCCESS"
    Write-Log "Timestamp: $Timestamp" "SUCCESS"
    Write-Log "Target: $Target" "SUCCESS"
    Write-Log "Ambiente: $Environment" "SUCCESS"
    Write-Log "Hora de in√≠cio: $($StartTime.ToString('dd/MM/yyyy HH:mm:ss'))" "SUCCESS"
    Write-Log "Hora de conclus√£o: $($EndTime.ToString('dd/MM/yyyy HH:mm:ss'))" "SUCCESS"
    
    # Salvar log
    Save-Log
    
    Write-Host "üìä ESTAT√çSTICAS DO DEPLOY:" -ForegroundColor $Cyan
    Write-Host "‚è±Ô∏è  Tempo total: $($TotalTime.TotalSeconds.ToString('F2')) segundos" -ForegroundColor $Yellow
    Write-Host "üìÅ Arquivos no deploy: $FileCount" -ForegroundColor $Yellow
    Write-Host "üì¶ Tamanho do ZIP: $ZipSize MB" -ForegroundColor $Yellow
    Write-Host "‚è∞ Timestamp: $Timestamp" -ForegroundColor $Yellow
    Write-Host "üéØ Target: $Target" -ForegroundColor $Yellow
    Write-Host "üåç Ambiente: $Environment" -ForegroundColor $Yellow
    Write-Host ""
    Write-Host "üìã PR√ìXIMOS PASSOS:" -ForegroundColor $Blue
    Write-Host "1. Fa√ßa upload do arquivo: $ZipPath" -ForegroundColor $White
    Write-Host "2. Extraia no diret√≥rio public_html do servidor" -ForegroundColor $White
    Write-Host "3. Configure o banco de dados" -ForegroundColor $White
    Write-Host "4. Teste a aplica√ß√£o" -ForegroundColor $White
    Write-Host ""
    Write-Host "üìÑ Log detalhado salvo em: $LogFile" -ForegroundColor $Cyan
    Write-Host "üöÄ Deploy autom√°tico finalizado com sucesso!" -ForegroundColor $Green

} catch {
    $EndTime = Get-Date
    $TotalTime = $EndTime - $StartTime
    
    Write-Log "ERRO NO DEPLOY AUTOM√ÅTICO" "ERROR"
    Write-Log "Erro: $($_.Exception.Message)" "ERROR"
    Write-Log "Tempo at√© o erro: $($TotalTime.TotalSeconds.ToString('F2')) segundos" "ERROR"
    Write-Log "Hora do erro: $($EndTime.ToString('dd/MM/yyyy HH:mm:ss'))" "ERROR"
    
    # Salvar log mesmo com erro
    Save-Log
    
    Write-Host "‚ùå ERRO NO DEPLOY AUTOM√ÅTICO:" -ForegroundColor $Red
    Write-Host "Erro: $($_.Exception.Message)" -ForegroundColor $Red
    Write-Host "Tempo at√© o erro: $($TotalTime.TotalSeconds.ToString('F2')) segundos" -ForegroundColor $Red
    Write-Host "Log de erro salvo em: $LogFile" -ForegroundColor $Red
    exit 1
}